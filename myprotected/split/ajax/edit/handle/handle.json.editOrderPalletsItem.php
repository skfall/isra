<?php 	//********************	//** WEB MIRACLE TECHNOLOGIES	//********************		// get post		$appTable = $_POST['appTable'];		$item_id = $_POST['item_id'];		$promo_code = $_POST['promo_code'];	$promocode_id = 0;	$discountx = 0;	$subtotal = 0;	$total = 0;	$delivery = 0;	$now = date('Y-m-d H:i:s');		$lpx = $_POST['lpx'];	$lang_prefix = ($lpx ? $lpx."_" : ""); // empty = en		$q = "SELECT * FROM [pre]o_orders WHERE `id`='$item_id' LIMIT 1";	$order = $ah->rs($q,1);		$user_id = $order['user_id'];		if($promo_code)	{		$q = "SELECT * FROM [pre]o_coupons WHERE `code`='$promo_code' AND `expires` > NOW() AND (`user_for`='0' || `user_for`='$user_id') LIMIT 1";		$promo = $ah->rs($q,1);				if($promo && $promo['id'] != $order['promocode_id'])		{			$promo_id = $promo['id'];			$q = "SELECT * FROM [pre]o_coupons_using WHERE `coupon_id`='$promo_id' LIMIT 1";			$promo_used = $ah->rs($q,1);						if($promo_used)			{				if($promo['reusable']) {					$promocode_id = $promo_id;					$discountx = $promo['value']; 				}			}else{				$promocode_id = $promo_id;				$discountx = $promo['value']; 			}		}	}		$userInfo = array(		"phone" => $_POST['phone'],		"second_phone" => $_POST['second_phone'],		"house" => "",//$_POST['house'],		"city" => "",//$_POST['city'],		"street" => "",//$_POST['street'],		"zipcode" => "",//$_POST['zipcode'],		"intercom" => "",//$_POST['intercom'],		"floor" => "",//$_POST['floor'],		"flat" => "",//$_POST['flat'],		"lift" => "",//$_POST['lift'][0],		"comment" => $_POST['comment'],	);						//echo "<pre>"; print_r($userInfo); echo "</pre>";exit();		$jsonUserInfo = json_encode ($userInfo, JSON_UNESCAPED_UNICODE);		$cardUpd = array(					'buch_num'			=> $_POST['buch_num'],					'entrance'			=> $_POST['entrance'],					'fix_price'			=> 0,					'new'				=> 0,					'status'			=> $_POST['status'],					'pay_status_id'		=> $_POST['pay_status_id'],					'pay_method_id'		=> $_POST['pay_method_id'],										'delivery_date'		=> date("Y-m-d", strtotime($_POST['delivery_date']))." ".$_POST['time_delivery_date'].":00",					//'pickup_date'		=> date("Y-m-d", strtotime($_POST['pickup_date']))." ".$_POST['time_pickup_date'].":00",										'finish_date'		=> date("Y-m-d H:i:s", strtotime($_POST['finish_date'])),										'description'			=> $jsonUserInfo,					);		// Doc upload 		$filename = "doc";		if(isset($_FILES[$filename]) && $_FILES[$filename]['size'] > 0)	{		$file_path = "../../../../split/files/content/";				$file_update = $ah->mtvc_add_files_file(array(				'path'			=>$file_path,				'name'			=>5,				'pre'			=>"doc_",				'size'			=>10,				'rule'			=>0,				'max_w'			=>2500,				'max_h'			=>2500,				'files'			=>$filename			  ));		if($file_update)		{			$cardUpd[$filename] = $file_update;						$curr_filename = $_POST['curr_docname'];						unlink($file_path.$curr_filename);		}	}	$fiveDays = 60*60*24*5;						$dateStart = strtotime($cardUpd['delivery_date']);	//$datePickup = strtotime($cardUpd['pickup_date']);	$dateFinish = strtotime($cardUpd['finish_date']);		$dateLimit = ( ($dateFinish - $dateStart) > $fiveDays ? ($dateFinish - $fiveDays) : $dateFinish );		$storageDays    = ceil( ($dateFinish - $dateStart)/(60*60*24) );    $storageDays    = $storageDays ? $storageDays : 1;		$storageMonthes    = ceil( ($dateLimit - $dateStart)/(60*60*24*31) );    $storageMonthes    = $storageMonthes ? $storageMonthes : 1;		$q = "SELECT SUM(price) as sum FROM [pre]o_orders_boxes WHERE `order_id`='$item_id'";	$boxes = $ah->rs($q,1);		// Subtotal +1	// if($boxes) $subtotal += $boxes['sum']*$storageDays;	if($boxes) $subtotal += $boxes['sum']*$storageMonthes;		$data['s_subtotal'] = $subtotal;		$q = "SELECT SUM(amount) as sum FROM [pre]o_orders_extras WHERE `order_id`='$item_id'";	$extras = $ah->rs($q,1);		// Subtotal +1	if($extras) $subtotal += $extras['sum'];		// ORDERS PRICES SETTINGS	$q = "SELECT * FROM [pre]o_prices WHERE `id`='1' LIMIT 1";	$o_prices = $ah->rs($q,1);		$shipping = $o_prices['delivery_sum'];		// Delivery +1	// if( ($datePickup-$dateStart) > 60*60 ) $delivery = $shipping;		// Total +1	$total = $subtotal;	if($promocode_id) $total = $total - ( $total / 100 * $discountx );		$total += $delivery;		if($total <= 0){			$total = 1;		}		$cardUpd['promocode_id'] = $promocode_id;		$cardUpd['subtotal'] = floor($subtotal);	$cardUpd['total'] = floor($total);	$cardUpd['shipping'] = floor($delivery);	$cardUpd['discount'] = floor($promocode_id ? $promo['value'] : 0);			if(isset($_POST['fix_price']))	{		if($_POST['fix_price'][0]==1)		{			$cardUpd['fix_price'] = 1;			$cardUpd['total'] = (float)$_POST['total'];			$cardUpd['shipping'] = (float)$_POST['shipping'];		}	}		// Update main table		$query = "UPDATE [pre]$appTable SET ";		$cntUpd = 0;	foreach($cardUpd as $field => $itemUpd)	{		$cntUpd++;		$query .= ($cntUpd==1 ? "`$field`='$itemUpd'" : ", `$field`='$itemUpd'");	}		$query .= " WHERE `id`=$item_id LIMIT 1";				$ah->rs($query);			$data['message'] = "Заказ успешно сохранен. ".($promocode_id ? "Promo sale: -".$promo['value'] : "No discount.");	