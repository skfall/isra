<?php 	//********************	//** WEB INSPECTOR	//********************		require_once "../../../require.base.php";		require_once "../../library/AjaxHelp.php";		$ah = new ajaxHelp($dbh);		$order_id	= (int)$_POST['order_id'];	$box_id 	= (int)$_POST['box_id'];	$ref_id 	= (int)$_POST['ref_id'];		$action = (isset($_POST['action']) ? $_POST['action'] : "open");	$r = array('status'=>'success','message'=>'Бокс успешно назначен','articel'=>0);			switch($action)	{		case 'save':			$old_box_id 	= (int)$_POST['old_box_id'];			$q = "UPDATE [pre]o_boxes SET `order_id`='0' WHERE `id`='$old_box_id' LIMIT 1";			$ah->dbh->q($q,0,1);						$q = "UPDATE [pre]o_boxes SET `order_id`='$order_id' WHERE `id`='$box_id' LIMIT 1";			$ah->dbh->q($q,0,1);						$q = "UPDATE [pre]o_orders_boxes SET `box_id`='$box_id' WHERE `id`='$ref_id' LIMIT 1";			$ah->dbh->q($q,0,1);						echo json_encode($r); exit();			break;		case 'add_to_return':					$is_unset = $_POST['is_unset'];						$q = "SELECT `description` FROM [pre]o_orders WHERE `id`='$order_id' LIMIT 1";			$order = $ah->rs($q,1);						if($order)			{				$desc = json_decode($order['description'], true, 512, JSON_UNESCAPED_UNICODE);				if($desc)				{					if(isset($desc['boxes_return']))					{						if( filter_var($is_unset, FILTER_VALIDATE_BOOLEAN)==true ){								$_index = array_search($ref_id, $desc['boxes_return']);								if($_index >= 0){										unset($desc['boxes_return'][$_index]);									}							}else{								array_push($desc['boxes_return'],$ref_id);							}													$new_desc = json_encode($desc, JSON_UNESCAPED_UNICODE);												$q = "UPDATE [pre]o_orders SET `description`='$new_desc' WHERE `id`='$order_id'";						$ah->rs($q,0,1);					}				}			}			echo json_encode($r); exit();			break;		default:break;	}		$q = "SELECT * FROM [pre]o_boxes WHERE `order_id`=0 ORDER BY `article` ASC LIMIT 10000";	$items = $ah->dbh->q($q);		$select_html = $ah->print_select(									"Выбрать свободную коробку", 									$box_id, 									$items,									'id', 									'article', 									"box_id", 									"save_box_to_order_place($order_id, $box_id, $(this).val(), $ref_id);", 									array( 'name'=>'-- BOX не выбран --', 'id'=>0 ),									'',									'float:none; width:90%; margin:0 auto; margin-bottom:25px;',									'width:100%;'									); ?><!DOCTYPE><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>SET BOX TO ORDER PLACE SCRIPT</title></head><body>	<button class="close-modal" onClick="close_modal();">Закрыть окно</button>    <div class="modalW" id="modalW-1">    	<h4>Выберите свободный BOX, система автоматически его переназначит</h4>                <?php        // echo "<pre>"; print_r($items); echo "</pre>";		echo $select_html;		?>                <div id="set_box_response"></div>    </div></body></html>